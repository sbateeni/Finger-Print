import streamlit as st
from datetime import datetime
import os
import logging

logger = logging.getLogger(__name__)

def display_summary_results(original_count, partial_count, matched_points, match_score, decision):
    """Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬"""
    st.markdown("---")
    st.subheader("ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬")
    
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS Ù„Ù„Ù†Øµ Ø§Ù„Ø¹Ø±ÙŠØ¶ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
    st.markdown("""
    <style>
    .result-box {
        background-color: #f0f2f6;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
        font-family: 'Arial', sans-serif;
        direction: rtl;
    }
    .result-item {
        font-size: 18px;
        margin: 10px 0;
    }
    .highlight {
        color: #0068c9;
        font-weight: bold;
    }
    .success {
        color: #09ab3b;
        font-weight: bold;
    }
    .high-match {
        color: #09ab3b;
        font-weight: bold;
        font-size: 24px;
        padding: 10px;
        background-color: rgba(9, 171, 59, 0.1);
        border-radius: 5px;
    }
    .medium-match {
        color: #f0a202;
        font-weight: bold;
        font-size: 24px;
        padding: 10px;
        background-color: rgba(240, 162, 2, 0.1);
        border-radius: 5px;
    }
    .low-match {
        color: #ff0000;
        font-weight: bold;
        font-size: 24px;
        padding: 10px;
        background-color: rgba(255, 0, 0, 0.1);
        border-radius: 5px;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    st.markdown('<div class="result-box">', unsafe_allow_html=True)
    
    # Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·
    st.markdown(f'<div class="result-item">ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ©: <span class="highlight">{original_count}</span></div>', unsafe_allow_html=True)
    st.markdown(f'<div class="result-item">ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©: <span class="highlight">{partial_count}</span></div>', unsafe_allow_html=True)
    
    # Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    st.markdown(f'<div class="result-item">âœ… Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ·Ø§Ø¨Ù‚: <span class="success">{matched_points}</span></div>', unsafe_allow_html=True)
    st.markdown(f'<div class="result-item">âœ… Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡: <span class="success">{match_score:.2f}%</span></div>', unsafe_allow_html=True)
    
    # Ø§Ù„Ù‚Ø±Ø§Ø±
    decision_class = "high-match" if match_score > 75 else "medium-match" if match_score > 50 else "low-match"
    decision_text = f'HIGH MATCH - Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§' if match_score > 75 else f'MEDIUM MATCH - Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ù…ØªÙˆØ³Ø·Ø©' if match_score > 50 else f'LOW MATCH - Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ù…Ù†Ø®ÙØ¶Ø©'
    
    st.markdown(f'<div class="result-item">âœ… Ø§Ù„Ù‚Ø±Ø§Ø±: <span class="{decision_class}">{decision_text}</span></div>', unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

def write_results_to_file(match_result):
    """ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Ù…Ù„Ù"""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if not os.path.exists('results'):
            os.makedirs('results')
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f'results/match_result_{timestamp}.txt'
        
        with open(filename, 'w', encoding='utf-8') as f:
            f.write("=== Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¨ØµÙ…Ø§Øª ===\n\n")
            f.write(f"ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
            f.write("=== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ===\n")
            f.write(f"Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚: {match_result['match_score']:.2f}%\n")
            f.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: {match_result['total_original']}\n")
            f.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©: {match_result['total_partial']}\n")
            f.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©: {match_result['matched_points']}\n")
            f.write(f"Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: {match_result['status']}\n\n")
            
            f.write("=== ØªÙØ§ØµÙŠÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· ===\n")
            if match_result['details']['ridge_analysis']:
                for i, analysis in enumerate(match_result['details']['ridge_analysis'], 1):
                    f.write(f"\nØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø· {i}:\n")
                    f.write(f"Ø§Ù„Ù…Ø³Ø§ÙØ©: {analysis['distance']:.2f}\n")
                    f.write(f"Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ©: {analysis['angle_difference']:.2f}\n")
                    f.write(f"ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†ÙˆØ¹: {'Ù†Ø¹Ù…' if analysis['type_match'] else 'Ù„Ø§'}\n")
            
        return filename
    except Exception as e:
        logger.error(f"Error writing results to file: {str(e)}")
        return None 